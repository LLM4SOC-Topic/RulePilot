description: The following analytic identifies a source endpoint failing to authenticate
  with multiple invalid users using the NTLM protocol. It leverages EventCode 4776
  and calculates the standard deviation for each host, using the 3-sigma rule to detect
  anomalies. This behavior is significant as it may indicate a Password Spraying attack,
  where an adversary attempts to gain initial access or elevate privileges. If confirmed
  malicious, this activity could lead to unauthorized access or privilege escalation,
  posing a significant threat to the Active Directory environment. This detection
  is focused on domain controllers.
required_fields:
- _time
- EventCode
- TargetUserName
- Workstation
- Status
rule: eventtype=wineventlog_security OR Channel=security OR source=XmlWinEventLog:Security
  EventCode=4776 TargetUserName!=*$ Status=0xc0000064 | bucket span=2m _time | stats
  dc(TargetUserName) AS unique_accounts values(TargetUserName) as user by _time, Workstation
  | eventstats avg(unique_accounts) as comp_avg , stdev(unique_accounts) as comp_std
  by Workstation | eval upperBound=(comp_avg+comp_std*3) | eval isOutlier=if(unique_accounts
  > 10 and unique_accounts >= upperBound, 1, 0) | search isOutlier=1 | rename Workstation
  as src |`windows_unusual_count_of_invalid_users_failed_to_auth_using_ntlm_filter`
