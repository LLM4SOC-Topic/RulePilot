description: The following analytic detects the execution of the Windows OS tool cmdkey.exe,
  which is often abused by post-exploitation tools like winpeas, commonly used in
  ransomware attacks to list stored usernames, passwords, or credentials. This detection
  leverages data from Endpoint Detection and Response (EDR) agents, focusing on process
  execution logs. This activity is significant as it indicates potential credential
  harvesting, which can lead to privilege escalation and persistence. If confirmed
  malicious, attackers could gain unauthorized access to sensitive information and
  maintain control over compromised systems for further exploitation.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
- Processes.parent_process_guid
- Processes.process_guid
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where Processes.process_name="cmdkey.exe" OR Processes.original_file_name
  = "cmdkey.exe" AND Processes.process = "*/list*" by Processes.process_name Processes.original_file_name
  Processes.process Processes.process_id Processes.process_guid Processes.parent_process_name
  Processes.parent_process Processes.parent_process_guid Processes.dest Processes.user
  | `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `windows_credentials_from_password_stores_query_filter`'
