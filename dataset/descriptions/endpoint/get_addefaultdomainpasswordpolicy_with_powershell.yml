description: The following analytic detects the execution of `powershell.exe` running
  the `Get-ADDefaultDomainPasswordPolicy` cmdlet, which is used to retrieve the password
  policy in a Windows domain. This detection leverages data from Endpoint Detection
  and Response (EDR) agents, focusing on process names and command-line executions.
  Monitoring this activity is crucial as it can indicate attempts by adversaries to
  gather information about domain policies for situational awareness and Active Directory
  discovery. If confirmed malicious, this activity could lead to further reconnaissance
  and potential exploitation of domain security settings.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_id
- Processes.parent_process_name
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.process_name="cmd.exe" OR Processes.process_name="powershell*")
  AND Processes.process = "*Get-ADDefaultDomainPasswordPolicy*" by Processes.dest
  Processes.user Processes.parent_process Processes.process_name Processes.process
  Processes.process_id Processes.parent_process_id Processes.parent_process_name |
  `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `get_addefaultdomainpasswordpolicy_with_powershell_filter`'
