description: The following analytic detects instances where an adversary modifies
  security permissions of a file or directory using commands like "icacls.exe", "cacls.exe",
  or "xcacls.exe" with deny options. It leverages data from Endpoint Detection and
  Response (EDR) agents, focusing on process names and command-line executions. This
  activity is significant as it is commonly used by Advanced Persistent Threats (APTs)
  and coinminer scripts to evade detection and impede access to critical files. If
  confirmed malicious, this could allow attackers to maintain persistence and hinder
  incident response efforts.
required_fields:
- _time
- Processes.parent_process_name
- Processes.process_name
- Processes.dest
- Processes.user
- Processes.process_id
- Processes.process
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where Processes.process_name IN( "icacls.exe",
  "cacls.exe", "xcacls.exe") AND Processes.process IN ("*/deny*", "*/D*") by Processes.parent_process_name
  Processes.parent_process Processes.process_name Processes.process Processes.process_guid
  Processes.dest Processes.user | `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `icacls_deny_command_filter`'
