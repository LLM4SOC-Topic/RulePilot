description: The following analytic detects the spawning of cmd or PowerShell processes
  by the wermgr.exe process. It leverages data from Endpoint Detection and Response
  (EDR) agents, focusing on process telemetry, including parent-child process relationships
  and command-line executions. This behavior is significant as it is commonly associated
  with code injection techniques used by malware like TrickBot to execute shellcode
  or malicious DLL modules. If confirmed malicious, this activity could allow attackers
  to execute arbitrary code, escalate privileges, or maintain persistence within the
  environment, posing a severe threat to system security.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` values(Processes.process) as cmdline min(_time)
  as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name
  = "wermgr.exe" (Processes.process_name=cmd.exe OR Processes.original_file_name=Cmd.Exe)
  OR (Processes.process_name=pwsh.exe OR Processes.process_name=sqlps.exe OR Processes.process_name=sqltoolsps.exe
  OR Processes.process_name=powershell.exe OR Processes.process_name=powershell_ise.exe
  OR Processes.original_file_name=pwsh.dll OR Processes.original_file_name=PowerShell.EXE
  OR Processes.original_file_name=powershell_ise.EXE) by Processes.parent_process_name  Processes.original_file_name
  Processes.parent_process_id  Processes.process_name Processes.process Processes.process_id
  Processes.process_guid Processes.dest Processes.user | `drop_dm_object_name(Processes)`
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `wermgr_process_spawned_cmd_or_powershell_process_filter`'
