description: The following analytic detects the execution of `powershell.exe` with
  command-line arguments invoking the `GetCurrent` method of the WindowsIdentity .NET
  class. This detection leverages data from Endpoint Detection and Response (EDR)
  agents, focusing on process names and command-line executions. This activity is
  significant as adversaries may use this method to identify the logged-in user on
  a compromised endpoint, aiding in situational awareness and Active Directory discovery.
  If confirmed malicious, this could allow attackers to gain insights into user context,
  potentially facilitating further exploitation and lateral movement within the network.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.process_name="powershell.exe")
  (Processes.process=*System.Security.Principal.WindowsIdentity* OR Processes.process=*GetCurrent()*)
  by Processes.dest Processes.user Processes.parent_process Processes.process_name
  Processes.process Processes.process_id Processes.parent_process_id | `drop_dm_object_name(Processes)`
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `getcurrent_user_with_powershell_filter`'
