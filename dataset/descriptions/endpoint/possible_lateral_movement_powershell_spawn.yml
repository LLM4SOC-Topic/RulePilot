description: The following analytic detects the spawning of a PowerShell process as
  a child or grandchild of commonly abused processes like services.exe, wmiprsve.exe,
  svchost.exe, wsmprovhost.exe, and mmc.exe. It leverages data from Endpoint Detection
  and Response (EDR) agents, focusing on process and parent process names, as well
  as command-line executions. This activity is significant as it often indicates lateral
  movement or remote code execution attempts by adversaries. If confirmed malicious,
  this behavior could allow attackers to execute code remotely, escalate privileges,
  or persist within the environment.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.parent_process_name=wmiprvse.exe
  OR Processes.parent_process_name=services.exe OR Processes.parent_process_name=svchost.exe
  OR Processes.parent_process_name=wsmprovhost.exe OR Processes.parent_process_name=mmc.exe)
  (Processes.process_name=powershell.exe OR (Processes.process_name=cmd.exe AND Processes.process=*powershell.exe*)
  OR Processes.process_name=pwsh.exe OR (Processes.process_name=cmd.exe AND Processes.process=*pwsh.exe*))
  NOT (Processes.process IN ("*c:\\windows\\ccm\\*")) by Processes.dest Processes.user
  Processes.parent_process_name Processes.process_name Processes.process Processes.process_id
  Processes.parent_process_id | `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `possible_lateral_movement_powershell_spawn_filter`'
