description: The following analytic is to leverage alerts from Microsoft Defender
  ATP Alerts. This query aggregates and summarizes all alerts from Microsoft Defender
  ATP Alerts, providing details such as the source, file name, severity, process command
  line, ip address, registry key, signature, description, unique id, and timestamps.
  This detection is not intended to detect new activity from raw data, but leverages
  Microsoft provided alerts to be correlated with other data as part of risk based
  alerting. The data contained in the alert is mapped not only to the risk obejct,
  but also the threat object. This detection filters out evidence that has a verdict
  of clean from Microsoft. It dynamically maps the MITRE technique at search time
  to auto populate the annotation field with the value provided in the alert. It also
  uses a dynamic mapping to set the risk score in Enterprise Security based on the
  severity of the alert.
required_fields:
- _time
- entityType
- filePath
- processCommandLine
- ipAddress
- registryKey
- url
- fileName
- risk_score
- firstTime
- lastTime
- src
- severity
- annotations.mitre_attack
- signature
- user
rule: ' `ms_defender_atp_alerts` (dest=* OR user=*)| eval tmp_evidence=json_extract(_raw,
  "evidence"), tmp_evidencemv=json_array_to_mv(tmp_evidence), entityType = mvmap(tmp_evidencemv,
  spath(tmp_evidencemv, "entityType")), filePath = mvmap(tmp_evidencemv, spath(tmp_evidencemv,
  "filePath")), processCommandLine = mvmap(tmp_evidencemv, spath(tmp_evidencemv, "processCommandLine")),
  ipAddress = mvmap(tmp_evidencemv, spath(tmp_evidencemv, "ipAddress")), registryKey
  = mvmap(tmp_evidencemv, spath(tmp_evidencemv, "registryKey")), url = mvmap(tmp_evidencemv,
  spath(tmp_evidencemv, "url")), fileName = mvmap(tmp_evidencemv, spath(tmp_evidencemv,
  "fileName")) | eval tmp_evidencemv=mvfilter(json_extract(tmp_evidencemv, "entityType")
  = "File"), fileName = mvmap(tmp_evidencemv, spath(tmp_evidencemv, "fileName")) |
  eval risk_score=case(severity="informational", 5, severity="low", 15, severity="medium",
  25, severity="high", 50 , true(), 2) | eval processCommandLine=if(processCommandLine="null",
  "", processCommandLine), ipAddress=if(ipAddress="null", "", ipAddress), registryKey=if(registryKey="null",
  "", registryKey), url=if(url="null", "", url) | stats count min(_time) as firstTime
  max(_time) as lastTime values(fileName) as file_name values(severity) as severity
  values(processCommandLine) as process values(ipAddress) as ip_address values(registryKey)
  as registry_key values(url) as url values(mitreTechniques{}) as annotations.mitre_attack.mitre_technique_id
  values(signature) as signature values(user) as user values(risk_score) as risk_score
  by id description src | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) |
  convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `microsoft_defender_atp_alerts_filter`'
