description: The following analytic identifies potential Kerberos ticket forging attacks,
  specifically the Diamond Ticket attack. This is detected when a user logs into a
  host and the GroupMembership field in event 4627 indicates a privileged group (e.g.,
  Domain Admins), but the user does not actually belong to that group in the directory
  service. The detection leverages Windows Security Event Log 4627, which logs account
  logon events. The analytic cross-references the GroupMembership field from the event
  against a pre-populated lookup of actual group memberships. Its crucial to note
  that the accuracy and effectiveness of this detection heavily rely on the users
  diligence in populating and regularly updating this lookup table. Any discrepancies
  between the events GroupMembership and the lookup indicate potential ticket forging.
  Kerberos ticket forging, especially the Diamond Ticket attack, allows attackers
  to impersonate any user and potentially gain unauthorized access to resources. By
  forging a ticket that indicates membership in a privileged group, an attacker can
  bypass security controls and gain elevated privileges. Detecting such discrepancies
  in group memberships during logon events can be a strong indicator of this attack
  in progress, making it crucial for security teams to monitor and investigate. If
  validated as a true positive, this indicates that an attacker has successfully forged
  a Kerberos ticket and may have gained unauthorized access to critical resources,
  potentially with elevated privileges.
required_fields:
- _time,
- EventCode
- LogonType
- TargetUserName
- GroupMembership
rule: eventtype=wineventlog_security OR Channel=security OR source=XmlWinEventLog:Security  EventCode=4627
  LogonType=3 NOT TargetUserName IN ("*$", "SYSTEM", "DWM-*","LOCAL SERVICE","NETWORK
  SERVICE", "ANONYMOUS LOGON", "UMFD-*") | where match(GroupMembership, "Domain Admins")
  | stats  count by _time, TargetUserName, GroupMembership, host | lookup domain_admins
  username as TargetUserName OUTPUT username | fillnull value=NotDA username | search
  username = "NotDA" | `windows_domain_admin_impersonation_indicator_filter`
