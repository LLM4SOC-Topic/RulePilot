description: The following analytic detects the use of `bitsadmin.exe` to schedule
  a BITS job for persistence on an endpoint. It leverages data from Endpoint Detection
  and Response (EDR) agents, focusing on specific command-line parameters such as
  `create`, `addfile`, and `resume`. This activity is significant because BITS jobs
  can be used by attackers to maintain persistence, download malicious payloads, or
  exfiltrate data. If confirmed malicious, this could allow an attacker to persist
  in the environment, execute arbitrary code, or transfer sensitive information, necessitating
  further investigation and potential remediation.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.process_name=bitsadmin.exe OR
  Processes.original_file_name=bitsadmin.exe) Processes.process IN (*create*, *addfile*,
  *setnotifyflags*, *setnotifycmdline*, *setminretrydelay*, *setcustomheaders*, *resume*
  ) by Processes.dest Processes.user Processes.original_file_name Processes.parent_process
  Processes.parent_process_name Processes.process_name Processes.process Processes.process_id
  Processes.parent_process_id | `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `bits_job_persistence_filter`'
