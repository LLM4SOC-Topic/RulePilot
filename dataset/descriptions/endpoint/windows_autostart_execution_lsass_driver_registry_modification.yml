description: The following analytic detects modifications to undocumented registry
  keys that allow a DLL to load into lsass.exe, potentially capturing credentials.
  It leverages the Endpoint.Registry data model to identify changes to \CurrentControlSet\Services\NTDS\DirectoryServiceExtPt
  or \CurrentControlSet\Services\NTDS\LsaDbExtPt. This activity is significant as
  it indicates a possible attempt to inject malicious code into the Local Security
  Authority Subsystem Service (LSASS), which can lead to credential theft. If confirmed
  malicious, this could allow attackers to gain unauthorized access to sensitive information
  and escalate privileges within the environment.
required_fields:
- _time
- Registry.registry_key_name
- Registry.registry_path
- Registry.user
- Registry.dest
- Registry.registry_value_name
- Registry.action
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  FROM datamodel=Endpoint.Registry where Registry.registry_path IN ("*\\CurrentControlSet\\Services\\NTDS\\DirectoryServiceExtPt","*\\CurrentControlSet\\Services\\NTDS\\LsaDbExtPt")
  by Registry.registry_key_name Registry.user Registry.registry_path Registry.registry_value_data
  Registry.action Registry.dest Registry.process_guid | `drop_dm_object_name(Registry)`
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `windows_autostart_execution_lsass_driver_registry_modification_filter`'
