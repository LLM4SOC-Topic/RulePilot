description: The following analytic detects suspicious PowerShell script execution
  involving the cryptography namespace via EventCode 4104. It leverages PowerShell
  Script Block Logging to identify scripts using cryptographic functions, excluding
  common hashes like SHA and MD5. This activity is significant as it is often associated
  with malware that decrypts or decodes additional malicious payloads. If confirmed
  malicious, this could allow an attacker to execute further code, escalate privileges,
  or establish persistence within the environment. Analysts should investigate the
  parent process, decrypted data, network connections, and the user executing the
  script.
required_fields:
- _time
- ScriptBlockText
- Opcode
- Computer
- UserID
- EventCodes
rule: (source=WinEventLog:Microsoft-Windows-PowerShell/Operational OR source="XmlWinEventLog:Microsoft-Windows-PowerShell/Operational")
  EventCode=4104 ScriptBlockText = "*System.Security.Cryptography*" AND NOT(ScriptBlockText
  IN ("*SHA*", "*MD5*", "*DeriveBytes*")) | stats count min(_time) as firstTime max(_time)
  as lastTime by EventCode ScriptBlockText Computer UserID | rename Computer as dest
  | rename UserID as user | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `windows_powershell_cryptography_namespace_filter`
