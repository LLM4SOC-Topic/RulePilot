description: The following analytic detects Microsoft Excel spawning PowerShell, an
  uncommon and suspicious behavior. This detection leverages data from Endpoint Detection
  and Response (EDR) agents, focusing on process creation events where the parent
  process is "excel.exe" and the child process is PowerShell. This activity is significant
  because it is often associated with spearphishing attacks, where malicious attachments
  execute encoded PowerShell commands. If confirmed malicious, this behavior could
  allow an attacker to execute arbitrary code, potentially leading to data exfiltration,
  privilege escalation, or persistent access within the environment.
required_fields:
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count values(Processes.process) min(_time) as firstTime
  max(_time) as lastTime from datamodel=Endpoint.Processes where Processes.parent_process_name="excel.exe"
  (Processes.process_name=pwsh.exe OR Processes.process_name=sqlps.exe OR Processes.process_name=sqltoolsps.exe
  OR Processes.process_name=powershell.exe OR Processes.process_name=powershell_ise.exe
  OR Processes.original_file_name=pwsh.dll OR Processes.original_file_name=PowerShell.EXE
  OR Processes.original_file_name=powershell_ise.EXE) by Processes.parent_process
  Processes.parent_process_name Processes.process_name Processes.user Processes.dest
  Processes.original_file_name | `drop_dm_object_name("Processes")` | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$)|convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `excel_spawning_powershell_filter`'
