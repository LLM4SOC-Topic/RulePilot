description: The following analytic identifies suspicious PowerShell script execution
  via EventCode 4104, where WMI performs an event query to list running processes
  or services. This detection leverages PowerShell Script Block Logging to capture
  and analyze script block text for specific WMI queries. This activity is significant
  as it is commonly used by malware and APT actors to map security applications or
  services on a compromised machine. If confirmed malicious, this could allow attackers
  to identify and potentially disable security defenses, facilitating further compromise
  and persistence within the environment.
required_fields:
- _time
- ScriptBlockText
- Opcode
- Computer
- UserID
- EventCode
rule: (source=WinEventLog:Microsoft-Windows-PowerShell/Operational OR source="XmlWinEventLog:Microsoft-Windows-PowerShell/Operational")
  EventCode=4104 ScriptBlockText= "*SELECT*" AND (ScriptBlockText="*Win32_Process*"
  OR ScriptBlockText="*Win32_Service*") | stats count min(_time) as firstTime max(_time)
  as lastTime by EventCode ScriptBlockText Computer UserID | rename Computer as dest
  | rename UserID as user | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `wmi_recon_running_process_or_services_filter`
