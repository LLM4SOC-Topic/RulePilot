description: The following analytic identifies instances where explorer.exe is spawned
  by unusual parent processes such as cmd.exe, powershell.exe, or regsvr32.exe. This
  detection leverages data from Endpoint Detection and Response (EDR) agents, focusing
  on process and parent process relationships. This activity is significant because
  explorer.exe is typically initiated by userinit.exe, and deviations from this norm
  can indicate code injection or process masquerading attempts by malware like Qakbot.
  If confirmed malicious, this behavior could allow attackers to execute arbitrary
  code, evade detection, and maintain persistence within the environment.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where Processes.parent_process_name IN("cmd.exe",
  "powershell.exe", "regsvr32.exe") AND Processes.process_name = "explorer.exe" AND
  Processes.process IN ("*\\explorer.exe") by Processes.parent_process Processes.parent_process_name
  Processes.process_name Processes.process_id Processes.process_guid Processes.process
  Processes.user Processes.dest Processes.parent_process_id | `drop_dm_object_name("Processes")`
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) |convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `windows_masquerading_explorer_as_child_process_filter`'
