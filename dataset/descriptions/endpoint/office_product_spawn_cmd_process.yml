description: The following analytic detects an Office product spawning a CMD process,
  which is indicative of a macro executing shell commands to download or run malicious
  code. This detection leverages data from Endpoint Detection and Response (EDR) agents,
  focusing on process and parent process names. This activity is significant as it
  often signals the execution of malicious payloads, such as those seen in Trickbot
  spear-phishing campaigns. If confirmed malicious, this behavior could lead to unauthorized
  code execution, potentially compromising the system and allowing further malicious
  activities.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.parent_process_name = "winword.exe"
  OR Processes.parent_process_name= "excel.exe" OR Processes.parent_process_name =
  "powerpnt.exe" OR Processes.parent_process_name= "onenote.exe" OR Processes.parent_process_name
  = "onenotem.exe" OR Processes.parent_process_name = "onenoteviewer.exe" OR Processes.parent_process_name
  = "onenoteim.exe" OR Processes.parent_process_name = "msaccess.exe" OR  Processes.parent_process_name="Graph.exe"
  OR Processes.parent_process_name="winproj.exe") (Processes.process_name=cmd.exe
  OR Processes.original_file_name=Cmd.Exe) by  Processes.parent_process_name Processes.parent_process
  Processes.process_name Processes.process Processes.process_id Processes.process_guid
  Processes.user Processes.dest Processes.original_file_name | `drop_dm_object_name("Processes")`
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) |convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `office_product_spawn_cmd_process_filter`'
