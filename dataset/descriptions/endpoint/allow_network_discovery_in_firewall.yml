description: The following analytic detects a suspicious modification to the firewall
  to allow network discovery on a machine. It leverages data from Endpoint Detection
  and Response (EDR) agents, focusing on command-line executions involving the 'netsh'
  command to enable network discovery. This activity is significant because it is
  commonly used by ransomware, such as REvil and RedDot, to discover and compromise
  additional machines on the network. If confirmed malicious, this could lead to widespread
  file encryption across multiple hosts, significantly amplifying the impact of the
  ransomware attack.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.process_name=netsh.exe OR Processes.original_file_name=netsh.exe)
  Processes.process= "*firewall*" Processes.process= "*group=\"Network Discovery\"*"  Processes.process="*enable*"
  Processes.process="*Yes*" by Processes.dest Processes.user Processes.parent_process
  Processes.original_file_name Processes.process_name Processes.process Processes.process_id
  Processes.parent_process_id Processes.parent_process_name | `drop_dm_object_name(Processes)`
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `allow_network_discovery_in_firewall_filter`'
