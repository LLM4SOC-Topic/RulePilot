description: The following analytic detects the execution of the Windows OS tool cmdkey.exe,
  which is used to create stored usernames, passwords, or credentials. This detection
  leverages data from Endpoint Detection and Response (EDR) agents, focusing on process
  execution logs and command-line arguments. This activity is significant because
  cmdkey.exe is often abused by post-exploitation tools and malware, such as Darkgate,
  to gain unauthorized access. If confirmed malicious, this behavior could allow attackers
  to escalate privileges and maintain persistence on the targeted host, facilitating
  further attacks and potential data breaches.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
- Processes.parent_process_guid
- Processes.process_guid
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where Processes.process_name="cmdkey.exe" OR Processes.original_file_name
  = "cmdkey.exe" AND Processes.process = "*/generic*" Processes.process IN ("*/user*",
  "*/password*") by Processes.process_name Processes.original_file_name Processes.process
  Processes.process_id Processes.process_guid Processes.parent_process_name Processes.parent_process
  Processes.parent_process_guid Processes.dest Processes.user | `drop_dm_object_name(Processes)`
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `windows_credentials_from_password_stores_creation_filter`'
