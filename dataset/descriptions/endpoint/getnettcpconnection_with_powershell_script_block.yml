description: The following analytic detects the execution of the `Get-NetTcpconnection`
  PowerShell cmdlet using PowerShell Script Block Logging (EventCode=4104). This cmdlet
  lists network connections on a system, which adversaries may use for situational
  awareness and Active Directory discovery. Monitoring this activity is crucial as
  it can indicate reconnaissance efforts by an attacker. If confirmed malicious, this
  behavior could allow an attacker to map the network, identify critical systems,
  and plan further attacks, potentially leading to data exfiltration or lateral movement
  within the network.
required_fields:
- _time
- ScriptBlockText
- Opcode
- Computer
- UserID
- EventCode
rule: (source=WinEventLog:Microsoft-Windows-PowerShell/Operational OR source="XmlWinEventLog:Microsoft-Windows-PowerShell/Operational")
  EventCode=4104 (ScriptBlockText = "*Get-NetTcpconnection*") | stats count min(_time)
  as firstTime max(_time) as lastTime by Opcode Computer UserID EventCode ScriptBlockText
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `getnettcpconnection_with_powershell_script_block_filter`
