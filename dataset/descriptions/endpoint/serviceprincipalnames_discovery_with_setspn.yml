description: The following analytic detects the use of `setspn.exe` to query the domain
  for Service Principal Names (SPNs). This detection leverages Endpoint Detection
  and Response (EDR) data, focusing on specific command-line arguments associated
  with `setspn.exe`. Monitoring this activity is crucial as it often precedes Kerberoasting
  or Silver Ticket attacks, which can lead to credential theft. If confirmed malicious,
  an attacker could use the gathered SPNs to escalate privileges or persist within
  the environment, posing a significant security risk.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.process_name=setspn.exe OR Processes.original_file_name=setspn.exe)
  (Processes.process="*-t*" AND Processes.process="*-f*") OR (Processes.process="*-q*"
  AND Processes.process="**/**") OR (Processes.process="*-q*") OR (Processes.process="*-s*")
  by Processes.dest Processes.user Processes.parent_process_name Processes.process_name
  Processes.original_file_name Processes.process Processes.process_id Processes.parent_process_id
  | `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)| `serviceprincipalnames_discovery_with_setspn_filter`'
