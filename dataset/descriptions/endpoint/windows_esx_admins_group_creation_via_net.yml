description: This analytic detects attempts to create an "ESX Admins" group using
  the Windows net.exe or net1.exe commands. This activity may indicate an attempt
  to exploit the VMware ESXi Active Directory Integration Authentication Bypass vulnerability
  (CVE-2024-37085). Attackers can use this method to gain unauthorized access to ESXi
  hosts by recreating the "ESX Admins" group after its deletion from Active Directory.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.original_file_name
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.process_name="net.exe" OR Processes.original_file_name="net.exe"
  OR Processes.process_name="net1.exe" OR Processes.original_file_name="net1.exe")
  AND (Processes.process="*group \"ESX Admins\"*" OR Processes.process="*group ESX
  Admins*") AND Processes.process="*/add*" by Processes.dest Processes.user Processes.parent_process_name
  Processes.parent_process Processes.process_name Processes.process Processes.process_id
  Processes.original_file_name | `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `windows_esx_admins_group_creation_via_net_filter`'
