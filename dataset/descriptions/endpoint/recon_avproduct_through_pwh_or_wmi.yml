description: The following analytic detects suspicious PowerShell script execution
  via EventCode 4104, specifically targeting checks for installed anti-virus products
  using WMI or PowerShell commands. This detection leverages PowerShell Script Block
  Logging to identify scripts containing keywords like "SELECT," "WMIC," "AntiVirusProduct,"
  or "AntiSpywareProduct." This activity is significant as it is commonly used by
  malware and APT actors to map running security applications or services, potentially
  aiding in evasion techniques. If confirmed malicious, this could allow attackers
  to disable or bypass security measures, leading to further compromise of the endpoint.
required_fields:
- _time
- EventCode
- ScriptBlockText
- Computer
- UserID
rule: (source=WinEventLog:Microsoft-Windows-PowerShell/Operational OR source="XmlWinEventLog:Microsoft-Windows-PowerShell/Operational")
  EventCode=4104 (ScriptBlockText = "*SELECT*" OR ScriptBlockText = "*WMIC*") AND
  (ScriptBlockText = "*AntiVirusProduct*" OR ScriptBlockText = "*AntiSpywareProduct*")
  | stats count min(_time) as firstTime max(_time) as lastTime by EventCode ScriptBlockText
  Computer UserID | rename Computer as dest | rename UserID as user | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `recon_avproduct_through_pwh_or_wmi_filter`
