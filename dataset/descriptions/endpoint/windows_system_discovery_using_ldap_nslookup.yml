description: The following analytic detects the execution of nslookup.exe to query
  domain information using LDAP. It leverages data from Endpoint Detection and Response
  (EDR) agents, focusing on process names and command-line arguments. This activity
  is significant as nslookup.exe can be abused by malware like Qakbot to gather critical
  domain details, such as SRV records and server names. If confirmed malicious, this
  behavior could allow attackers to map the network, identify key servers, and plan
  further attacks, potentially leading to data exfiltration or lateral movement within
  the network.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.process_name = "nslookup.exe"
  OR Processes.original_file_name = "nslookup.exe") AND Processes.process = "*_ldap._tcp.dc._msdcs*"
  by Processes.parent_process Processes.parent_process_name Processes.process_name
  Processes.process_id Processes.process_guid Processes.process Processes.user Processes.dest
  Processes.parent_process_id Processes.original_file_name | `drop_dm_object_name("Processes")`
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) |convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `windows_system_discovery_using_ldap_nslookup_filter`'
