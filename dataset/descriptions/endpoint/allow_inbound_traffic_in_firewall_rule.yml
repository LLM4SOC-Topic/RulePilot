description: The following analytic detects a suspicious PowerShell command that allows
  inbound traffic to a specific local port within the public profile. It leverages
  PowerShell script block logging (EventCode 4104) to identify commands containing
  keywords like "firewall," "Inbound," "Allow," and "-LocalPort." This activity is
  significant because it may indicate an attacker attempting to establish remote access
  by modifying firewall rules. If confirmed malicious, this could allow unauthorized
  access to the machine, potentially leading to further exploitation and data exfiltration.
required_fields:
- _time
- EventCode
- ScriptBlockText
- Computer
- UserID
rule: (source=WinEventLog:Microsoft-Windows-PowerShell/Operational OR source="XmlWinEventLog:Microsoft-Windows-PowerShell/Operational")
  EventCode=4104 ScriptBlockText = "*firewall*" ScriptBlockText = "*Inbound*" ScriptBlockText
  = "*Allow*"  ScriptBlockText = "*-LocalPort*" | stats count min(_time) as firstTime
  max(_time) as lastTime by EventCode ScriptBlockText Computer UserID | rename Computer
  as dest | rename UserID as user | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `allow_inbound_traffic_in_firewall_rule_filter`
