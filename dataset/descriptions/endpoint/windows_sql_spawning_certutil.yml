description: The following analytic detects the use of certutil to download software,
  specifically when spawned by SQL-related processes. This detection leverages Endpoint
  Detection and Response (EDR) data, focusing on command-line executions involving
  certutil with parameters like *urlcache* and *split*. This activity is significant
  as it may indicate a compromise by threat actors, such as Flax Typhoon, who use
  certutil to establish persistent VPN connections. If confirmed malicious, this behavior
  could allow attackers to maintain access, monitor system availability, and potentially
  escalate to data theft or ransomware deployment.
required_fields:
- Processes.dest
- Processes.user
- Processes.parent_process
- Processes.parent_process_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.original_file_name
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where Processes.parent_process_name IN ("sqlservr.exe",
  "sqlagent.exe", "sqlps.exe", "launchpad.exe", "sqldumper.exe") (Processes.process_name=certutil.exe
  OR Processes.original_file_name=CertUtil.exe) (Processes.process=*urlcache* Processes.process=*split*)
  OR Processes.process=*urlcache* by Processes.dest Processes.user Processes.parent_process
  Processes.parent_process_name Processes.process_name Processes.process Processes.process_id
  Processes.original_file_name Processes.parent_process_id | `drop_dm_object_name(Processes)`
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `windows_sql_spawning_certutil_filter`'
