description: The following analytic detects modifications to the Windows firewall
  to enable Remote Desktop Protocol (RDP) on a targeted machine. It leverages data
  from Endpoint Detection and Response (EDR) agents, focusing on command-line executions
  involving "netsh.exe" to allow TCP port 3389. This activity is significant as it
  may indicate an adversary attempting to gain remote access to a compromised host,
  a common tactic for lateral movement. If confirmed malicious, this could allow attackers
  to remotely control the system, leading to potential data exfiltration or further
  network compromise.
required_fields:
- _time
- Processes.process_name
- Processes.process
- Processes.parent_process_name
- Processes.parent_process
- Processes.process_id
- Processes.parent_process_id
- Processes.dest
- Processes.user
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` values(Processes.process) as cmdline values(Processes.parent_process_name)
  as parent_process values(Processes.process_name) count min(_time) as firstTime max(_time)
  as lastTime from datamodel=Endpoint.Processes where (Processes.process_name = "netsh.exe"
  OR Processes.original_file_name= "netsh.exe") AND Processes.process = "*firewall*"
  AND Processes.process = "*add*" AND Processes.process = "*protocol=TCP*" AND Processes.process
  = "*localport=3389*" AND Processes.process = "*action=allow*" by Processes.dest
  Processes.user Processes.parent_process Processes.process_name Processes.process
  Processes.process_id Processes.parent_process_id | `drop_dm_object_name(Processes)`
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `windows_remote_services_allow_rdp_in_firewall_filter`'
