description: The following analytic detects the execution of the Get-DomainTrust command
  from PowerView using PowerShell Script Block Logging (EventCode=4104). This method
  captures the full command sent to PowerShell, allowing for detailed inspection.
  Identifying this activity is significant because it may indicate an attempt to gather
  domain trust information, which is often a precursor to lateral movement or privilege
  escalation. If confirmed malicious, this activity could enable an attacker to map
  trust relationships within the domain, potentially leading to further exploitation
  and compromise of additional systems.
required_fields:
- _time
- ScriptBlockText
- Opcode
- Computer
- UserID
- EventCode
rule: (source=WinEventLog:Microsoft-Windows-PowerShell/Operational OR source="XmlWinEventLog:Microsoft-Windows-PowerShell/Operational")
  EventCode=4104 ScriptBlockText = "*get-domaintrust*" | stats count min(_time) as
  firstTime max(_time) as lastTime by Opcode Computer UserID EventCode ScriptBlockText
  | rename Computer as dest | rename UserID as user | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `get_domaintrust_with_powershell_script_block_filter`
