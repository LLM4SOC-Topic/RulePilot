description: The following analytic detects potential WMI token impersonation activities
  in a process or command. It leverages Sysmon EventCode 10 to identify instances
  where `wmiprvse.exe` has a duplicate handle or full granted access in a target process.
  This behavior is significant as it is commonly used by malware like Qakbot for privilege
  escalation or defense evasion. If confirmed malicious, this activity could allow
  an attacker to gain elevated privileges, evade defenses, and maintain persistence
  within the environment.
required_fields:
- _time
- SourceImage
- TargetImage
- SourceProcessGUID
- TargetProcessGUID
- SourceProcessId
- TargetProcessId
- GrantedAccess
- CallTrace
- dest
rule: sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational OR source=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational
  OR source=Syslog:Linux-Sysmon/Operational EventCode=10 SourceImage = "*\\wmiprvse.exe"  GrantedAccess
  IN ("0x1478", "0x1fffff") | stats count min(_time) as firstTime max(_time) as lastTime
  by SourceImage TargetImage SourceProcessGUID TargetProcessGUID SourceProcessId TargetProcessId
  GrantedAccess CallTrace dest | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `windows_wmi_impersonate_token_filter`
