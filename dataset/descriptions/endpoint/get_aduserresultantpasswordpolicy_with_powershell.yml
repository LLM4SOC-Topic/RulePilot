description: The following analytic detects the execution of `powershell.exe` running
  the `Get-ADUserResultantPasswordPolicy` cmdlet, which is used to obtain the password
  policy in a Windows domain. It leverages data from Endpoint Detection and Response
  (EDR) agents, focusing on process names and command-line executions. This activity
  is significant as it indicates potential enumeration of domain policies, a common
  tactic for situational awareness and Active Directory discovery by adversaries.
  If confirmed malicious, this could allow attackers to understand password policies,
  aiding in further attacks such as password spraying or brute force attempts.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_id
- Processes.parent_process_name
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.process_name="cmd.exe" OR Processes.process_name="powershell*")
  AND Processes.process = "*Get-ADUserResultantPasswordPolicy*" by Processes.dest
  Processes.user Processes.parent_process Processes.process_name Processes.process
  Processes.process_id Processes.parent_process_id Processes.parent_process_name |
  `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `get_aduserresultantpasswordpolicy_with_powershell_filter`'
