description: The following analytic detects the execution of the `Get-DomainUser`
  cmdlet using PowerShell Script Block Logging (EventCode=4104). This cmdlet is part
  of PowerView, a tool often used for domain enumeration. The detection leverages
  PowerShell operational logs to identify instances where this command is executed.
  Monitoring this activity is crucial as it may indicate an adversary's attempt to
  gather information about domain users, which is a common step in Active Directory
  Discovery. If confirmed malicious, this activity could lead to further reconnaissance
  and potential exploitation of domain resources.
required_fields:
- _time
- EventCode
- Message
- ComputerName
- User
rule: (source=WinEventLog:Microsoft-Windows-PowerShell/Operational OR source="XmlWinEventLog:Microsoft-Windows-PowerShell/Operational")
  EventCode=4104 ScriptBlockText = "*Get-DomainUser*" | stats count min(_time) as
  firstTime max(_time) as lastTime by EventCode ScriptBlockText Computer UserID |
  rename Computer as dest, UserID as user| convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `get_domainuser_with_powershell_script_block_filter`
