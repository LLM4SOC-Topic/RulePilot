description: The following analytic identifies a source endpoint failing to authenticate
  with multiple invalid domain users using the Kerberos protocol. It leverages Event
  ID 4768, which is generated when the Key Distribution Center issues a Kerberos Ticket
  Granting Ticket (TGT) and detects failure code 0x6, indicating the user is not found
  in the Kerberos database. This behavior is significant as it may indicate a Password
  Spraying attack, where an adversary attempts to gain initial access or elevate privileges.
  If confirmed malicious, this activity could lead to unauthorized access and potential
  privilege escalation within the Active Directory environment.
required_fields:
- _time
- EventCode
- Status
- TargetUserName
- IpAddress
rule: eventtype=wineventlog_security OR Channel=security OR source=XmlWinEventLog:Security
  EventCode=4768 TargetUserName!=*$ Status=0x6 | bucket span=5m _time | stats dc(TargetUserName)
  AS unique_accounts values(TargetUserName) as user by _time, IpAddress | eventstats
  avg(unique_accounts) as comp_avg , stdev(unique_accounts) as comp_std by IpAddress
  | eval upperBound=(comp_avg+comp_std*3) | eval isOutlier=if(unique_accounts > 10
  and unique_accounts >= upperBound, 1, 0) | search isOutlier=1 | `windows_unusual_count_of_invalid_users_fail_to_auth_using_kerberos_filter`
