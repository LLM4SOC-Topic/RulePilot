description: The following analytic detects the execution of the PowerShell cmdlet
  `get-localgroup` using PowerShell Script Block Logging (EventCode=4104). This method
  captures the full command sent to PowerShell, providing detailed visibility into
  script execution. Monitoring this activity is significant as it can indicate an
  attempt to enumerate local groups, which may be a precursor to privilege escalation
  or lateral movement. If confirmed malicious, an attacker could gain insights into
  group memberships, potentially leading to unauthorized access or privilege abuse.
  Review parallel processes and the entire script block for comprehensive analysis.
required_fields:
- _time
- ScriptBlockText
- Opcode
- Computer
- UserID
- EventCode
rule: (source=WinEventLog:Microsoft-Windows-PowerShell/Operational OR source="XmlWinEventLog:Microsoft-Windows-PowerShell/Operational")
  EventCode=4104 ScriptBlockText = "*get-localgroup*" | stats count min(_time) as
  firstTime max(_time) as lastTime by Opcode Computer UserID EventCode ScriptBlockText  |
  rename Computer as dest, UserID as user | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) |convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `powershell_get_localgroup_discovery_with_script_block_logging_filter`
