description: The following analytic detects MSIExec spawning multiple discovery commands,
  such as Cmd.exe or PowerShell.exe. This behavior is identified using data from Endpoint
  Detection and Response (EDR) agents, focusing on process creation events where MSIExec
  is the parent process. This activity is significant because MSIExec typically does
  not spawn child processes other than itself, making this behavior highly suspicious.
  If confirmed malicious, an attacker could use these discovery commands to gather
  system information, potentially leading to further exploitation or lateral movement
  within the network.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where Processes.parent_process_name=msiexec.exe
  Processes.process_name IN ("powershell.exe", "pwsh.exe","cmd.exe", "nltest.exe","ipconfig.exe","systeminfo.exe")
  by Processes.dest Processes.user Processes.parent_process_name Processes.process_name
  Processes.original_file_name Processes.process Processes.process_id Processes.parent_process_id
  | `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `windows_msiexec_spawn_discovery_command_filter`'
