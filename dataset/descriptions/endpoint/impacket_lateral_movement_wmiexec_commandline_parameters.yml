description: The following analytic detects the use of Impacket's `wmiexec.py` tool
  for lateral movement by identifying specific command-line parameters. It leverages
  data from Endpoint Detection and Response (EDR) agents, focusing on processes spawned
  by `wmiprvse.exe` with command-line patterns indicative of Impacket usage. This
  activity is significant as Impacket tools are commonly used by adversaries for remote
  code execution and lateral movement within a network. If confirmed malicious, this
  could allow attackers to execute arbitrary commands on remote systems, potentially
  leading to further compromise and data exfiltration.
required_fields:
- Processes.process_name
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where Processes.parent_process_name=wmiprvse.exe
  by Processes.dest Processes.user Processes.parent_process_name Processes.process_name
  Processes.process Processes.process_id Processes.parent_process_id | `drop_dm_object_name(Processes)`
  | where match(process, "(?i)cmd\.exe\s+\/Q\s+\/c") AND match(process, "\\\\127\.0\.0\.1\\.*")
  AND match(process, "__\\d{1,10}\\.\\d{1,10}") | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)| `impacket_lateral_movement_wmiexec_commandline_parameters_filter`'
