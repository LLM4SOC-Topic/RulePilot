description: The following analytic identifies the use of netsh.exe to configure a
  connection proxy, which can be leveraged for persistence by executing a helper DLL.
  It detects this activity by analyzing process creation events from Endpoint Detection
  and Response (EDR) agents, focusing on command-line executions involving "portproxy"
  and "v4tov4" parameters. This activity is significant because it indicates potential
  unauthorized network configuration changes, which could be used to maintain persistence
  or redirect network traffic. If confirmed malicious, this could allow an attacker
  to maintain covert access or manipulate network communications, posing a significant
  security risk.
required_fields:
- _time
- Processes.process
- Processes.parent_process_name
- Processes.parent_process
- Processes.process_name
- Processes.user
- Processes.dest
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.process_name=netsh.exe OR Processes.original_file_name=netsh.exe)
  Processes.process = "* portproxy *" Processes.process = "* v4tov4 *" by Processes.parent_process_name
  Processes.parent_process Processes.original_file_name Processes.process_name Processes.process
  Processes.user Processes.dest |`drop_dm_object_name("Processes")` |convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) |convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `windows_proxy_via_netsh_filter`'
