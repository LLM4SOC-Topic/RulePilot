description: The following analytic detects the modification of registry keys related
  to the Windows Proxy settings via netsh.exe. It leverages data from the Endpoint.Registry
  data model, focusing on changes to the registry path "*\\System\\CurrentControlSet\\Services\\PortProxy\\v4tov4\\tcp*".
  This activity is significant because netsh.exe can be used to establish a persistent
  proxy, potentially allowing an attacker to execute a helper DLL whenever netsh.exe
  runs. If confirmed malicious, this could enable the attacker to maintain persistence,
  manipulate network configurations, and potentially exfiltrate data or further compromise
  the system.
required_fields:
- _time
- Registry.registry_key_name
- Registry.registry_path
- Registry.user
- Registry.dest
- Registry.registry_value_name
- Registry.action
- Registry.registry_value_data
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count  min(_time) as firstTime max(_time) as lastTime
  FROM datamodel=Endpoint.Registry where Registry.registry_path ="*\\System\\CurrentControlSet\\Services\\PortProxy\\v4tov4\\tcp*"
  by Registry.registry_path Registry.registry_key_name Registry.registry_value_name
  Registry.action Registry.dest  Registry.user | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `drop_dm_object_name(Registry)`
  | `windows_proxy_via_registry_filter`'
