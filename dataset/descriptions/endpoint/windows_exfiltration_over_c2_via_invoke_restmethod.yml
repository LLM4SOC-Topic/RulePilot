description: The following analytic detects potential data exfiltration using PowerShell's
  Invoke-RestMethod. It leverages PowerShell Script Block Logging to identify scripts
  that attempt to upload files via HTTP POST requests. This activity is significant
  as it may indicate an attacker is exfiltrating sensitive data, such as desktop screenshots
  or files, to an external command and control (C2) server. If confirmed malicious,
  this could lead to data breaches, loss of sensitive information, and further compromise
  of the affected systems. Immediate investigation is recommended to determine the
  intent and scope of the activity.
required_fields:
- _time
- ScriptBlockText
- Computer
- UserID
- EventCode
rule: (source=WinEventLog:Microsoft-Windows-PowerShell/Operational OR source="XmlWinEventLog:Microsoft-Windows-PowerShell/Operational")
  EventCode=4104 ScriptBlockText = "*Invoke-RestMethod *" AND ScriptBlockText = "*
  -Uri *" AND ScriptBlockText = "* -Method *" AND ScriptBlockText = "* Post *" AND
  ScriptBlockText = "* -InFile *" | stats count min(_time) as firstTime max(_time)
  as lastTime by EventCode ScriptBlockText Computer UserID | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `windows_exfiltration_over_c2_via_invoke_restmethod_filter`
