description: The following analytic detects the execution of PowerShell commands that
  use the `Invoke-Command` cmdlet to start a process on a remote endpoint via the
  WinRM protocol. It leverages PowerShell Script Block Logging (EventCode=4104) to
  identify such activities. This behavior is significant as it may indicate lateral
  movement or remote code execution attempts by adversaries. If confirmed malicious,
  this activity could allow attackers to execute arbitrary code on remote systems,
  potentially leading to further compromise and persistence within the network.
required_fields:
- _time
- ScriptBlockText
- Opcode
- Computer
- UserID
- EventCode
rule: (source=WinEventLog:Microsoft-Windows-PowerShell/Operational OR source="XmlWinEventLog:Microsoft-Windows-PowerShell/Operational")
  EventCode=4104 (ScriptBlockText="*Invoke-Command*" AND ScriptBlockText="*-ComputerName*")
  | stats count min(_time) as firstTime max(_time) as lastTime by EventCode ScriptBlockText
  Computer user_id | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert
  timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `remote_process_instantiation_via_winrm_and_powershell_script_block_filter`
