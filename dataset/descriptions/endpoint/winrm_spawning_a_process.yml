description: The following analytic detects suspicious processes spawned by WinRM
  (wsmprovhost.exe). It leverages data from Endpoint Detection and Response (EDR)
  agents, focusing on specific child processes like cmd.exe, powershell.exe, and others.
  This activity is significant as it may indicate exploitation attempts of vulnerabilities
  like CVE-2021-31166, which could lead to system instability or compromise. If confirmed
  malicious, attackers could execute arbitrary commands, escalate privileges, or maintain
  persistence, posing a severe threat to the environment.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where Processes.parent_process_name=wsmprovhost.exe
  Processes.process_name IN ("cmd.exe","sh.exe","bash.exe","powershell.exe","pwsh.exe","schtasks.exe","certutil.exe","whoami.exe","bitsadmin.exe","scp.exe")
  by Processes.dest Processes.user Processes.parent_process Processes.process_name
  Processes.process Processes.process_id Processes.parent_process_id | `drop_dm_object_name(Processes)`
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `winrm_spawning_a_process_filter`'
