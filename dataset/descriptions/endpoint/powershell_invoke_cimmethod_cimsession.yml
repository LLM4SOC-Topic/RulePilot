description: The following analytic detects the creation of a New-CIMSession cmdlet
  followed by the use of the Invoke-CIMMethod cmdlet within PowerShell. It leverages
  PowerShell Script Block Logging to identify these specific cmdlets in the ScriptBlockText
  field. This activity is significant because it mirrors the behavior of the Invoke-WMIMethod
  cmdlet, often used for remote code execution via NTLMv2 pass-the-hash authentication.
  If confirmed malicious, this could allow an attacker to execute commands remotely,
  potentially leading to unauthorized access and control over targeted systems.
required_fields:
- _time
- EventCode
- ScriptBlockText
- Computer
rule: (source=WinEventLog:Microsoft-Windows-PowerShell/Operational OR source="XmlWinEventLog:Microsoft-Windows-PowerShell/Operational")
  EventCode=4104 ScriptBlockText IN ("*invoke-CIMMethod*", "*New-CimSession*") | stats
  count min(_time) as firstTime max(_time) as lastTime by Computer EventCode ScriptBlockText
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `powershell_invoke_cimmethod_cimsession_filter`
