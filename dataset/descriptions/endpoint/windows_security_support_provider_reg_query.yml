description: The following analytic identifies command-line activity querying the
  registry for Security Support Providers (SSPs) related to Local Security Authority
  (LSA) protection and configuration. This detection leverages Endpoint Detection
  and Response (EDR) telemetry, focusing on processes accessing specific LSA registry
  paths. Monitoring this activity is crucial as adversaries and post-exploitation
  tools like winpeas may use it to gather information on LSA protections, potentially
  leading to credential theft. If confirmed malicious, attackers could exploit this
  to scrape password hashes or plaintext passwords from memory, significantly compromising
  system security.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
- Processes.parent_process_guid
- Processes.process_guid
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.process_name=reg.exe OR Processes.original_file_name=reg.exe)
  AND Processes.process = "* query *" AND Processes.process = "*\\SYSTEM\\CurrentControlSet\\Control\\LSA*"
  Processes.process IN ("*RunAsPPL*" , "*LsaCfgFlags*") by Processes.process_name
  Processes.original_file_name Processes.process Processes.process_id Processes.process_guid
  Processes.parent_process_name Processes.parent_process Processes.parent_process_guid
  Processes.dest Processes.user | `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `windows_security_support_provider_reg_query_filter`'
