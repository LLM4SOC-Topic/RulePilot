description: The following analytic detects the execution of `query.exe` with command-line
  arguments aimed at discovering logged-in users. It leverages data from Endpoint
  Detection and Response (EDR) agents, focusing on process names and command-line
  executions. This activity is significant as adversaries may use `query.exe` to gain
  situational awareness and perform Active Directory discovery on compromised endpoints.
  If confirmed malicious, this behavior could allow attackers to identify active users,
  aiding in further lateral movement and privilege escalation within the network.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.process_name="query.exe") (Processes.process=*user*)
  by Processes.dest Processes.user Processes.parent_process Processes.process_name
  Processes.process Processes.process_id Processes.parent_process_id | `drop_dm_object_name(Processes)`
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `system_user_discovery_with_query_filter`'
