description: The following analytic detects the use of PowerShell commands to copy
  the SAM, SYSTEM, or SECURITY hives, which are critical for credential theft. It
  leverages PowerShell Script Block Logging (EventCode=4104) to capture and analyze
  the full command executed. This activity is significant as it indicates an attempt
  to exfiltrate sensitive registry hives for offline password cracking. If confirmed
  malicious, this could lead to unauthorized access to credentials, enabling further
  compromise of the system and potential lateral movement within the network.
required_fields:
- _time
- ScriptBlockText
- OpCode
- Computer
- UserID
- EventCode
rule: (source=WinEventLog:Microsoft-Windows-PowerShell/Operational OR source="XmlWinEventLog:Microsoft-Windows-PowerShell/Operational")
  EventCode=4104 ScriptBlockText IN ("*copy*","*[System.IO.File]::Copy*") AND ScriptBlockText
  IN ("*System32\\config\\SAM*", "*System32\\config\\SYSTEM*","*System32\\config\\SECURITY*")
  | stats count min(_time) as firstTime max(_time) as lastTime by Opcode Computer
  UserID EventCode ScriptBlockText | rename Computer as dest | rename UserID as user
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `detect_copy_of_shadowcopy_with_script_block_logging_filter`
