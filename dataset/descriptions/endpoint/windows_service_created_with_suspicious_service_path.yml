description: The following analytic detects the creation of a Windows Service with
  a binary path located in uncommon directories, using Windows Event ID 7045. It leverages
  logs from the `wineventlog_system` to identify services installed outside typical
  system directories. This activity is significant as adversaries, including those
  deploying Clop ransomware, often create malicious services for lateral movement,
  remote code execution, persistence, and execution. If confirmed malicious, this
  could allow attackers to maintain persistence, execute arbitrary code, and potentially
  escalate privileges, posing a severe threat to the environment.
required_fields:
- EventCode
- Service_File_Name
- Service_Type
- _time
- Service_Name
- Service_Start_Type
- dest
rule: eventtype=wineventlog_system EventCode=7045 ImagePath = "*.exe" NOT (ImagePath
  IN ("*:\\Windows\\*", "*:\\Program File*", "*:\\Programdata\\*", "*%systemroot%\\*"))
  | stats count min(_time) as firstTime max(_time) as lastTime by EventCode ImagePath
  ServiceName ServiceType StartType Computer UserID | rename Computer as dest| convert
  timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `windows_service_created_with_suspicious_service_path_filter`
