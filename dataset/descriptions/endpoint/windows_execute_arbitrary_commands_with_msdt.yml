description: The following analytic detects arbitrary command execution using Windows
  msdt.exe, a Diagnostics Troubleshooting Wizard. It leverages Endpoint Detection
  and Response (EDR) data to identify instances where msdt.exe is invoked via the
  ms-msdt:/ protocol handler to retrieve a remote payload. This activity is significant
  as it can indicate an exploitation attempt leveraging msdt.exe to execute arbitrary
  commands, potentially leading to unauthorized code execution. If confirmed malicious,
  this could allow an attacker to execute arbitrary code, escalate privileges, or
  persist within the environment, posing a severe security risk.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where Processes.process_name=msdt.exe Processes.process
  IN ("*msdt*","*ms-msdt:*","*ms-msdt:/id*","*ms-msdt:-id*","*/id*") AND (Processes.process="*IT_BrowseForFile=*"
  OR Processes.process="*IT_RebrowseForFile=*" OR Processes.process="*.xml*") AND
  Processes.process="*PCWDiagnostic*" by Processes.dest Processes.user Processes.parent_process_name
  Processes.process_name Processes.process Processes.process_id Processes.parent_process_id
  | `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)| `windows_execute_arbitrary_commands_with_msdt_filter`'
