description: The following analytic detects the use of PowerShell commands to add
  or set Windows Defender exclusions. It leverages EventCode 4104 to identify suspicious
  `Add-MpPreference` or `Set-MpPreference` commands with exclusion parameters. This
  activity is significant because adversaries often use it to bypass Windows Defender,
  allowing malicious code to execute without detection. If confirmed malicious, this
  behavior could enable attackers to evade antivirus defenses, maintain persistence,
  and execute further malicious activities undetected.
required_fields:
- _time
- EventCode
- ScriptBlockText
- Computer
- UserID
rule: (source=WinEventLog:Microsoft-Windows-PowerShell/Operational OR source="XmlWinEventLog:Microsoft-Windows-PowerShell/Operational")
  EventCode=4104 (ScriptBlockText = "*Add-MpPreference *" OR ScriptBlockText = "*Set-MpPreference
  *") AND ScriptBlockText = "*-exclusion*" | stats count min(_time) as firstTime max(_time)
  as lastTime by EventCode ScriptBlockText Computer UserID | rename Computer as dest
  | rename UserID as user | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `powershell_windows_defender_exclusion_commands_filter`
