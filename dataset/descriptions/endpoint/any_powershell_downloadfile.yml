description: The following analytic detects the use of PowerShell's `DownloadFile`
  method to download files. It leverages data from Endpoint Detection and Response
  (EDR) agents, focusing on process execution logs. This activity is significant as
  it is commonly used in malicious frameworks to download and execute additional payloads.
  If confirmed malicious, this could lead to unauthorized code execution, data exfiltration,
  or further compromise of the system. Analysts should investigate the source and
  destination of the download and review AMSI or PowerShell transaction logs for additional
  context.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.process_name=pwsh.exe OR Processes.process_name=sqlps.exe
  OR Processes.process_name=sqltoolsps.exe OR Processes.process_name=powershell.exe
  OR Processes.process_name=powershell_ise.exe OR Processes.original_file_name=pwsh.dll
  OR Processes.original_file_name=PowerShell.EXE OR Processes.original_file_name=powershell_ise.EXE)
  Processes.process=*DownloadFile* by Processes.dest Processes.user Processes.parent_process
  Processes.process_name Processes.parent_process_name Processes.original_file_name
  Processes.process Processes.process_id Processes.parent_process_id | `drop_dm_object_name(Processes)`
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)| convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$)| `any_powershell_downloadfile_filter`'
