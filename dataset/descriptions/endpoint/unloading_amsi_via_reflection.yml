description: The following analytic detects the tampering of AMSI (Antimalware Scan
  Interface) via PowerShell reflection. It leverages PowerShell Script Block Logging
  (EventCode=4104) to capture and analyze suspicious PowerShell commands, specifically
  those involving `system.management.automation.amsi`. This activity is significant
  as it indicates an attempt to bypass AMSI, a critical security feature that helps
  detect and block malicious scripts. If confirmed malicious, this could allow an
  attacker to execute harmful code undetected, leading to potential system compromise
  and data exfiltration.
required_fields:
- _time
- ScriptBlockText
- Opcode
- Computer
- UserID
- EventCode
rule: (source=WinEventLog:Microsoft-Windows-PowerShell/Operational OR source="XmlWinEventLog:Microsoft-Windows-PowerShell/Operational")
  EventCode=4104 ScriptBlockText = *system.management.automation.amsi* | stats count
  min(_time) as firstTime max(_time) as lastTime by EventCode ScriptBlockText Computer
  user_id | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `unloading_amsi_via_reflection_filter`
