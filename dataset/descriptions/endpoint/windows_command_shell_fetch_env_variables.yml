description: The following analytic identifies a suspicious process command line fetching
  environment variables with a non-shell parent process. It leverages data from Endpoint
  Detection and Response (EDR) agents, focusing on command-line executions and parent
  process names. This activity is significant as it is commonly associated with malware
  like Qakbot, which uses this technique to gather system information. If confirmed
  malicious, this behavior could indicate that the parent process has been compromised,
  potentially allowing attackers to execute arbitrary commands, escalate privileges,
  or persist within the environment.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where Processes.process = "*cmd /c set" OR Processes.process
  = "*cmd.exe /c set" AND NOT (Processes.parent_process_name = "cmd.exe" OR Processes.parent_process_name
  = "powershell*" OR Processes.parent_process_name="pwsh.exe" OR Processes.parent_process_name
  = "explorer.exe") by Processes.dest Processes.user Processes.parent_process_name
  Processes.process_name Processes.process Processes.process_id Processes.parent_process_id
  Processes.original_file_name | `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `windows_command_shell_fetch_env_variables_filter`'
