description: The following analytic detects the restarting or re-enabling of services
  on Linux systems using the `systemctl` or `service` commands. It leverages data
  from Linux Auditd, focusing on process and command-line execution logs. This activity
  is significant as adversaries may use it to maintain persistence or execute unauthorized
  actions. If confirmed malicious, this behavior could lead to repeated execution
  of malicious payloads, unauthorized access, or data destruction. Security analysts
  should investigate these events to mitigate risks and prevent further compromise.
required_fields:
- _time
- proctitle
rule: sourcetype="linux:audit" type=PROCTITLE | eval normalized_proctitle_delimiter
  = if(type=="PROCTITLE" AND isnotnull(proctitle), if(match(proctitle,"^[0-9A-F]+$"),
  replace(proctitle, "000", "020"),proctitle),null()) | eval normalized_proctitle_delimiter  =
  if(type=="PROCTITLE" AND isnotnull(proctitle), if(match(normalized_proctitle_delimiter,"^[0-9A-F]+$"),
  replace(normalized_proctitle_delimiter, "00", "20"),normalized_proctitle_delimiter),null())
  | eval process_exec = if(match(normalized_proctitle_delimiter,"^[0-9A-F]+$"),urldecode(replace(normalized_proctitle_delimiter,"([0-9A-F]{2})","%\1")),normalized_proctitle_delimiter)
  | rename host as dest | where (LIKE(process_exec, "%systemctl %") OR LIKE(process_exec,
  "%service %") ) AND(LIKE(process_exec, "%restart%") OR LIKE(process_exec, "%reenable%")
  OR LIKE(process_exec, "%reload%")) | stats count min(_time) as firstTime max(_time)
  as lastTime by process_exec proctitle normalized_proctitle_delimiter dest | convert
  timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)| convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$)| `linux_auditd_service_restarted_filter`
