description: The following analytic detects the execution of `powershell.exe` with
  command-line arguments used to enumerate domain users via the `Get-ADUser` cmdlet.
  It leverages data from Endpoint Detection and Response (EDR) agents, focusing on
  process names and command-line executions. This activity is significant as it may
  indicate an attempt by adversaries to gather information about domain users for
  situational awareness and Active Directory discovery. If confirmed malicious, this
  behavior could lead to further reconnaissance, enabling attackers to identify high-value
  targets and plan subsequent attacks.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_id
- Processes.parent_process_name
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.process_name="cmd.exe" OR Processes.process_name="powershell*")
  AND Processes.process = "*Get-ADUser*" AND Processes.process = "*-filter*" by Processes.dest
  Processes.user Processes.parent_process Processes.process_name Processes.process
  Processes.process_id Processes.parent_process_id Processes.parent_process_name |
  `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `get_aduser_with_powershell_filter`'
