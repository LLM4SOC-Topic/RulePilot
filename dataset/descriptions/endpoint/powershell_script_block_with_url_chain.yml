description: The following analytic identifies suspicious PowerShell script execution
  via EventCode 4104 that contains multiple URLs within a function or array. It leverages
  PowerShell operational logs to detect script blocks with embedded URLs, often indicative
  of obfuscated scripts or those attempting to download secondary payloads. This activity
  is significant as it may signal an attempt to execute malicious code or download
  additional malware. If confirmed malicious, this could lead to code execution, further
  system compromise, or data exfiltration. Review parallel processes and the full
  script block for additional context and related artifacts.
required_fields:
- _time
- EventCode
- ActivityID
- Computer
- ScriptBlockText
rule: (source=WinEventLog:Microsoft-Windows-PowerShell/Operational OR source="XmlWinEventLog:Microsoft-Windows-PowerShell/Operational")
  EventCode=4104 ScriptBlockText IN ("*http:*","*https:*") | regex ScriptBlockText="(\"?(https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/=]*))\"?(?:,|\))?){2,}"
  | rex max_match=20 field=ScriptBlockText "(?<url>https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/=]*))"
  | eval Path = case(isnotnull(Path),Path,true(),"unknown") | stats count min(_time)
  as firstTime max(_time) as lastTime list(ScriptBlockText) as command values(Path)
  as file_name values(UserID) as user values(url) as url dc(url) as url_count by ActivityID,
  Computer, EventCode | rename Computer as dest, EventCode as signature_id | convert
  timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `powershell_script_block_with_url_chain_filter`
