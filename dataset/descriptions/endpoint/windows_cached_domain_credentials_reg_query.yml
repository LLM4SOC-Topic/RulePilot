description: The following analytic identifies a process command line querying the
  CachedLogonsCount registry value in the Winlogon registry. This detection leverages
  data from Endpoint Detection and Response (EDR) agents, focusing on command-line
  executions and registry queries. Monitoring this activity is significant as it can
  indicate the use of post-exploitation tools like Winpeas, which gather information
  about login caching settings. If confirmed malicious, this activity could help attackers
  understand login caching configurations, potentially aiding in credential theft
  or lateral movement within the network.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
- Processes.parent_process_guid
- Processes.process_guid
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where  (Processes.process_name=reg.exe OR Processes.original_file_name=reg.exe)
  AND Processes.process = "* query *" AND Processes.process = "*\\SOFTWARE\\Microsoft\\Windows
  NT\\CurrentVersion\\Winlogon*" AND Processes.process = "*CACHEDLOGONSCOUNT*" by
  Processes.process_name Processes.original_file_name Processes.process Processes.process_id
  Processes.process_guid Processes.parent_process_name Processes.parent_process Processes.parent_process_guid
  Processes.dest Processes.user | `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `windows_cached_domain_credentials_reg_query_filter`'
