description: The following analytic detects the execution of `powershell.exe` with
  arguments used to start a process on a remote endpoint by abusing the DCOM protocol,
  specifically targeting ShellExecute and ExecuteShellCommand. It leverages data from
  Endpoint Detection and Response (EDR) agents, focusing on process names, parent
  processes, and command-line executions. This activity is significant as it indicates
  potential lateral movement and remote code execution attempts by adversaries. If
  confirmed malicious, this could allow attackers to execute arbitrary code remotely,
  escalate privileges, and move laterally within the network, posing a severe security
  risk.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.process_name=pwsh.exe OR Processes.process_name=sqlps.exe
  OR Processes.process_name=sqltoolsps.exe OR Processes.process_name=powershell.exe
  OR Processes.process_name=powershell_ise.exe OR Processes.original_file_name=pwsh.dll
  OR Processes.original_file_name=PowerShell.EXE OR Processes.original_file_name=powershell_ise.EXE)
  (Processes.process="*Document.ActiveView.ExecuteShellCommand*" OR Processes.process="*Document.Application.ShellExecute*")
  by Processes.dest Processes.user Processes.parent_process_name Processes.process_name
  Processes.process Processes.process_id Processes.parent_process_id | `drop_dm_object_name(Processes)`
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)| convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `remote_process_instantiation_via_dcom_and_powershell_filter`'
