description: The following analytic identifies the use of certutil.exe with arguments
  indicating the manipulation or extraction of certificates. It leverages data from
  Endpoint Detection and Response (EDR) agents, focusing on process names and command-line
  arguments. This activity is significant because extracting certificates can allow
  attackers to sign new authentication tokens, particularly in federated environments
  like Windows ADFS. If confirmed malicious, this could enable attackers to forge
  authentication tokens, potentially leading to unauthorized access and privilege
  escalation within the network.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where Processes.process_name=certutil.exe Processes.process
  = "*-exportPFX*" by Processes.dest Processes.user Processes.parent_process Processes.parent_process_name
  Processes.process_name Processes.process Processes.process_id Processes.parent_process_id
  | `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `certutil_exe_certificate_extraction_filter`'
