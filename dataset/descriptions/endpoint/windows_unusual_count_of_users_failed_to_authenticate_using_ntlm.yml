description: The following analytic identifies a source endpoint failing to authenticate
  multiple valid users using the NTLM protocol, potentially indicating a Password
  Spraying attack. It leverages Event 4776 from Domain Controllers, calculating the
  standard deviation for each host and applying the 3-sigma rule to detect anomalies.
  This activity is significant as it may represent an adversary attempting to gain
  initial access or elevate privileges. If confirmed malicious, the attacker could
  compromise multiple accounts, leading to unauthorized access and potential lateral
  movement within the network.
required_fields:
- _time
- EventCode
- Status
- TargetUserName
- Workstation
rule: eventtype=wineventlog_security OR Channel=security OR source=XmlWinEventLog:Security  EventCode=4776
  TargetUserName!=*$ Status=0xC000006A | bucket span=2m _time | stats dc(TargetUserName)
  AS unique_accounts values(TargetUserName) as tried_accounts by _time, Workstation
  | eventstats avg(unique_accounts) as comp_avg , stdev(unique_accounts) as comp_std
  by Workstation | eval upperBound=(comp_avg+comp_std*3) | eval isOutlier=if(unique_accounts
  > 10 and unique_accounts >= upperBound, 1, 0) | search isOutlier=1 | `windows_unusual_count_of_users_failed_to_authenticate_using_ntlm_filter`
