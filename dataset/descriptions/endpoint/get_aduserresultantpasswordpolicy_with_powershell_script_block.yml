description: The following analytic detects the execution of the `Get-ADUserResultantPasswordPolicy`
  PowerShell cmdlet, which is used to obtain the password policy in a Windows domain.
  It leverages PowerShell Script Block Logging (EventCode=4104) to identify this activity.
  Monitoring this behavior is significant as it may indicate an attempt to enumerate
  domain policies, a common tactic used by adversaries for situational awareness and
  Active Directory discovery. If confirmed malicious, this activity could allow attackers
  to understand password policies, aiding in further attacks such as password guessing
  or policy exploitation.
required_fields:
- _time
- ScriptBlockText
- Opcode
- Computer
- UserID
- EventCode
rule: (source=WinEventLog:Microsoft-Windows-PowerShell/Operational OR source="XmlWinEventLog:Microsoft-Windows-PowerShell/Operational")
  EventCode=4104 ScriptBlockText="*Get-ADUserResultantPasswordPolicy*" | stats count
  min(_time) as firstTime max(_time) as lastTime by Opcode Computer UserID EventCode
  ScriptBlockText | rename Computer as dest | rename UserID as user | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `get_aduserresultantpasswordpolicy_with_powershell_script_block_filter`
