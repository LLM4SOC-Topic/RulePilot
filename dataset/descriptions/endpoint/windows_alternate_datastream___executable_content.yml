description: The following analytic detects the writing of data with an IMPHASH value
  to an Alternate Data Stream (ADS) in the NTFS file system. It leverages Sysmon Event
  ID 15 and regex to identify files with a Portable Executable (PE) structure. This
  activity is significant as it may indicate a threat actor staging malicious code
  in hidden areas for persistence or future execution. If confirmed malicious, this
  could allow attackers to execute hidden code, maintain persistence, or escalate
  privileges within the environment.
required_fields:
- _time
- dest
- TargetFilename
- Image
- Contents
- file_hash
- process_guid
- IMPHASH
rule: sourcetype=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational OR source=XmlWinEventLog:Microsoft-Windows-Sysmon/Operational
  OR source=Syslog:Linux-Sysmon/Operational EventCode=15 IMPHASH!=00000000000000000000000000000000
  | regex TargetFilename="(?<!\/)\b\w+(\.\w+)?:\w+(\.\w+)?$" | eval file_name = replace(TargetFilename,"(.*\\\)",""),
  process = Image , file_path = TargetFilename, file_hash = coalesce(SHA256,SHA1,MD5,Hash)
  | stats count min(_time) as firstTime max(_time) as lastTime values(user) as user
  by dest, process, process_guid, file_name, file_path, file_hash, IMPHASH | convert
  timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `windows_alternate_datastream___executable_content_filter`
