description: The following analytic detects the use of the Nishang Invoke-PowerShellTCPOneLine
  utility, which initiates a callback to a remote Command and Control (C2) server.
  It leverages Endpoint Detection and Response (EDR) data, focusing on PowerShell
  processes that include specific .NET classes like Net.Sockets.TCPClient and System.Text.ASCIIEncoding.
  This activity is significant as it indicates potential remote control or data exfiltration
  attempts by an attacker. If confirmed malicious, this could lead to unauthorized
  remote access, data theft, or further compromise of the affected system.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.process_name=pwsh.exe OR Processes.process_name=sqlps.exe
  OR Processes.process_name=sqltoolsps.exe OR Processes.process_name=powershell.exe
  OR Processes.process_name=powershell_ise.exe OR Processes.original_file_name=pwsh.dll
  OR Processes.original_file_name=PowerShell.EXE OR Processes.original_file_name=powershell_ise.EXE)
  (Processes.process=*Net.Sockets.TCPClient* AND Processes.process=*System.Text.ASCIIEncoding*)
  by Processes.dest Processes.user Processes.parent_process Processes.original_file_name
  Processes.process_name Processes.process Processes.process_id Processes.parent_process_id
  | `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)|
  convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)| `nishang_powershelltcponeline_filter`'
