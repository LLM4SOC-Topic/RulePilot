description: The following analytic detects the execution of `powershell.exe` using
  the `Invoke-WmiMethod` cmdlet to start a process on a remote endpoint via WMI. It
  leverages data from Endpoint Detection and Response (EDR) agents, focusing on command-line
  executions and process telemetry. This activity is significant as it indicates potential
  lateral movement or remote code execution attempts by adversaries. If confirmed
  malicious, this could allow attackers to execute arbitrary code on remote systems,
  leading to further compromise and persistence within the network.
required_fields:
- _time
- Processes.dest
- Processes.user
- Processes.parent_process_name
- Processes.parent_process
- Processes.original_file_name
- Processes.process_name
- Processes.process
- Processes.process_id
- Processes.parent_process_path
- Processes.process_path
- Processes.parent_process_id
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` count min(_time) as firstTime max(_time) as lastTime
  from datamodel=Endpoint.Processes where (Processes.process_name=pwsh.exe OR Processes.process_name=sqlps.exe
  OR Processes.process_name=sqltoolsps.exe OR Processes.process_name=powershell.exe
  OR Processes.process_name=powershell_ise.exe OR Processes.original_file_name=pwsh.dll
  OR Processes.original_file_name=PowerShell.EXE OR Processes.original_file_name=powershell_ise.EXE)
  (Processes.process="*Invoke-WmiMethod*" AND Processes.process="*-CN*" AND Processes.process="*-Class
  Win32_Process*" AND  Processes.process="*-Name create*") by Processes.dest Processes.user
  Processes.parent_process_name Processes.process_name Processes.process Processes.process_id
  Processes.parent_process_id | `drop_dm_object_name(Processes)` | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$)| convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `remote_process_instantiation_via_wmi_and_powershell_filter`'
