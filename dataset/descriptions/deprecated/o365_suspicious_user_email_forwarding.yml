description: '**DEPRECATION NOTE** - This search has been deprecated and replaced
  with `O365 Mailbox Email Forwarding Enabled`. The following analytic detects when
  multiple users have configured a forwarding rule to the same destination to proactively
  identify and investigate potential security risks related to email forwarding and
  take appropriate actions to protect the organizations data and prevent unauthorized
  access or data breaches. This detection is made by a Splunk query to O365 management
  activity logs with the operation `Set-Mailbox` to gather information about mailbox
  configurations. Then, the query uses the `spath` function to extract the parameters
  and rename the "Identity" field as "src_user" and searches for entries where the
  "ForwardingSmtpAddress" field is not empty, which indicates the presence of a forwarding
  rule. Next, the analytic uses the `stats` command to group the results by the forwarding
  email address and count the number of unique source users (`src_user`). Finally,
  it filters the results and only retains entries where the count of source users
  (`count_src_user`) is greater than 1, which indicates that multiple users have set
  up forwarding rules to the same destination. This detection is important because
  it suggests that multiple users are forwarding emails to the same destination without
  proper authorization, which can lead to the exposure of sensitive information, loss
  of data control, or unauthorized access to confidential emails. Investigating and
  addressing this issue promptly can help prevent data breaches and mitigate potential
  damage.indicates a potential security risk since multiple users forwarding emails
  to the same destination can be a sign of unauthorized access, data exfiltration,
  or a compromised account. Additionally, it also helps to determine if the forwarding
  rules are legitimate or if they indicate a security incident. False positives can
  occur if there are legitimate reasons for multiple users to forward emails to the
  same destination, such as a shared mailbox or a team collaboration scenario. Next
  steps include further investigation and context analysis to determine the legitimacy
  of the forwarding rules.'
required_fields:
- _time
- Operation
- Parameters
rule: sourcetype=o365:management:activity Operation=Set-Mailbox | spath input=Parameters
  | rename Identity AS src_user | search ForwardingSmtpAddress=* | stats dc(src_user)
  AS count_src_user earliest(_time) as firstTime latest(_time) as lastTime values(src_user)
  AS src_user values(user) AS user by ForwardingSmtpAddress | where count_src_user
  > 1 |convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) |convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) |`o365_suspicious_user_email_forwarding_filter`
