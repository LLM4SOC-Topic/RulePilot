description: This analytic is designed to identify attempts to exploit a server-side
  template injection vulnerability in CrushFTP, designated as CVE-2024-4040. This
  severe vulnerability enables unauthenticated remote attackers to access and read
  files beyond the VFS Sandbox, circumvent authentication protocols, and execute arbitrary
  commands on the affected server. The issue impacts all versions of CrushFTP up to
  10.7.1 and 11.1.0 on all supported platforms. It is highly recommended to apply
  patches immediately to prevent unauthorized access to the system and avoid potential
  data compromises. The search specifically looks for patterns in the raw log data
  that match the exploitation attempts, including READ or WRITE actions, and extracts
  relevant information such as the protocol, session ID, user, IP address, HTTP method,
  and the URI queried. It then evaluates these logs to confirm traces of exploitation
  based on the presence of specific keywords and the originating IP address, counting
  and sorting these events for further analysis.
required_fields:
- _time
- dest
- source
- src_ip
- http_method
- uri_query
- user
- action
- message
rule: 'sourcetype="crushftp:sessionlogs" | rex field=_raw "\[(?<protocol>HTTPS|HTTP):(?<session_id>[^\:]+):(?<user>[^\:]+):(?<src_ip>\d+\.\d+\.\d+\.\d+)\]
  (?<action>READ|WROTE): \*(?<http_method>[A-Z]+) (?<uri_query>[^\s]+) HTTP/[^\*]+\*"
  | eval message=if(match(_raw, "INCLUDE") and isnotnull(src_ip), "traces of exploitation
  by " . src_ip, "false") | search message!=false | rename host as dest | stats count
  by _time, dest, source, message, src_ip, http_method, uri_query, user, action |
  sort -_time| `crushftp_server_side_template_injection_filter`'
