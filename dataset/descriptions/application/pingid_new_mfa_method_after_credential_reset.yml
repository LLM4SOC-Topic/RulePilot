description: The following analytic identifies the provisioning of a new MFA device
  shortly after a password reset. It detects this activity by correlating Windows
  Event Log events for password changes (EventID 4723, 4724) with PingID logs indicating
  device pairing. This behavior is significant as it may indicate a social engineering
  attack where a threat actor impersonates a valid user to reset credentials and add
  a new MFA device. If confirmed malicious, this activity could allow an attacker
  to gain persistent access to the compromised account, bypassing traditional security
  measures.
required_fields:
- _time
- user
- src_user
- src
- EventID
- resources{}.ipaddress
- actors{}.name
- result.message
- resources{}.devicemodel
rule: source=PINGID "result.message" = "*Device Paired*" | rex field=result.message
  "Device (Unp)?(P)?aired (?<device_extract>.+)" | eval src = coalesce('resources{}.ipaddress','resources{}.devicemodel'),
  user = upper('actors{}.name'), reason = 'result.message' | eval object=CASE(ISNOTNULL('resources{}.devicemodel'),'resources{}.devicemodel',true(),device_extract)
  | eval action=CASE(match('result.message',"Device Paired*"),"created",match('result.message',
  "Device Unpaired*"),"deleted") | stats count min(_time) as firstTime, max(_time)
  as lastTime, values(reason) as reason by src,user,action,object | join type=outer
  user [| search eventtype=wineventlog_security OR Channel=security OR source=XmlWinEventLog:Security
  EventID IN(4723,4724) | eval PW_Change_Time = _time, user = upper(user) | fields
  user,src_user,EventID,PW_Change_Time] | eval timeDiffRaw = round(lastTime - PW_Change_Time)
  | eval timeDiff = replace(tostring(abs(timeDiffRaw) ,"duration"),"(\d*)\+*(\d+):(\d+):(\d+)","\2
  hours \3 minutes") | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert
  timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | where timeDiffRaw > 0 AND timeDiffRaw < 3600 | `pingid_new_mfa_method_after_credential_reset_filter`
