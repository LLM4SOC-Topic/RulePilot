description: The following analytic identifies a significant increase in data transfers
  from your email server to client hosts. It leverages the Network_Traffic data model
  to monitor outbound traffic from email servers, using statistical analysis to detect
  anomalies based on average and standard deviation metrics. This activity is significant
  as it may indicate a malicious actor exfiltrating data via your email server. If
  confirmed malicious, this could lead to unauthorized data access and potential data
  breaches, compromising sensitive information and impacting organizational security.
required_fields:
- _time
- All_Traffic.bytes_out
- All_Traffic.src_category
- All_Traffic.dest_ip
rule: '| tstats summariesonly=`summariesonly_config` allow_old_summaries=`oldsummaries_config`
  fillnull_value=`fillnull_config` sum(All_Traffic.bytes_out) as bytes_out from datamodel=Network_Traffic
  where All_Traffic.src_category=email_server by All_Traffic.dest_ip _time span=1d
  | `drop_dm_object_name("All_Traffic")` | eventstats avg(bytes_out) as avg_bytes_out
  stdev(bytes_out) as stdev_bytes_out | eventstats count as num_data_samples avg(eval(if(_time
  < relative_time(now(), "@d"), bytes_out, null))) as per_source_avg_bytes_out stdev(eval(if(_time
  < relative_time(now(), "@d"), bytes_out, null))) as per_source_stdev_bytes_out by
  dest_ip | eval minimum_data_samples = 4, deviation_threshold = 3 | where num_data_samples
  >= minimum_data_samples AND bytes_out > (avg_bytes_out + (deviation_threshold *
  stdev_bytes_out)) AND bytes_out > (per_source_avg_bytes_out + (deviation_threshold
  * per_source_stdev_bytes_out)) AND _time >= relative_time(now(), "@d") | eval num_standard_deviations_away_from_server_average
  = round(abs(bytes_out - avg_bytes_out) / stdev_bytes_out, 2), num_standard_deviations_away_from_client_average
  = round(abs(bytes_out - per_source_avg_bytes_out) / per_source_stdev_bytes_out,
  2) | table dest_ip, _time, bytes_out, avg_bytes_out, per_source_avg_bytes_out, num_standard_deviations_away_from_server_average,
  num_standard_deviations_away_from_client_average | `email_servers_sending_high_volume_traffic_to_hosts_filter`'
