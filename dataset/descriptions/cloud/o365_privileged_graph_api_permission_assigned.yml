description: The following analytic detects the assignment of critical Graph API permissions
  in Azure AD using the O365 Unified Audit Log. It focuses on permissions such as
  Application.ReadWrite.All, AppRoleAssignment.ReadWrite.All, and RoleManagement.ReadWrite.Directory.
  The detection method leverages Azure Active Directory workload events, specifically
  'Update application' operations. This activity is significant as these permissions
  provide extensive control over Azure AD settings, posing a high risk if misused.
  If confirmed malicious, this could allow unauthorized modifications, leading to
  potential data breaches or privilege escalation. Immediate investigation is crucial.
required_fields:
- _time
- Workload
- Operation
- ModifiedProperties{}.NewValue
- RequiredAppPermissions{}.EntitlementId
- user
- object
- user_agent
- Operation
rule: sourcetype=o365:management:activity Workload=AzureActiveDirectory Operation="Update
  application." | eval newvalue = mvindex('ModifiedProperties{}.NewValue',0) | spath
  input=newvalue  | search "{}.RequiredAppPermissions{}.EntitlementId"="1bfefb4e-e0b5-418b-a88f-73c46d2cc8e9"
  OR "{}.RequiredAppPermissions{}.EntitlementId"="06b708a9-e830-4db3-a914-8e69da51d44f"
  OR "{}.RequiredAppPermissions{}.EntitlementId"="9e3f62cf-ca93-4989-b6ce-bf83c28f9fe8"  |
  eval Permissions = '{}.RequiredAppPermissions{}.EntitlementId' | stats count earliest(_time)
  as firstTime latest(_time) as lastTime values(Permissions) by user, object, user_agent,
  Operation | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `o365_privileged_graph_api_permission_assigned_filter`
