description: The following analytic detects the registration of a new Multi-Factor
  Authentication (MFA) method for a user account within Office 365. It leverages O365
  audit logs to identify changes in MFA configurations. This activity is significant
  as it may indicate an attacker's attempt to maintain persistence on a compromised
  account. If confirmed malicious, the attacker could bypass existing security measures,
  solidify their access, and potentially escalate privileges or access sensitive data.
  Immediate verification and remediation are required to secure the affected account.
required_fields:
- _time
- Workload
- Operation
- ModifiedProperties{}.Name
- ModifiedProperties{}.OldValue
- ModifiedProperties{}.NewValue
rule: sourcetype=o365:management:activity Workload=AzureActiveDirectory  Operation="Update
  user."  | eval propertyName = mvindex('ModifiedProperties{}.Name', 0) | search propertyName
  = StrongAuthenticationMethod | eval oldvalue = mvindex('ModifiedProperties{}.OldValue',0)
  | eval newvalue = mvindex('ModifiedProperties{}.NewValue',0) | rex field=newvalue
  max_match=0 "(?i)(?<new_method_type>\"MethodType\")" | rex field=oldvalue max_match=0
  "(?i)(?<old_method_type>\"MethodType\")" | eval count_new_method_type = coalesce(mvcount(new_method_type),
  0) | eval count_old_method_type = coalesce(mvcount(old_method_type), 0) |  where
  count_new_method_type > count_old_method_type |  stats earliest(_time) as firstTime
  latest(_time) as lastTime values(propertyName) by user newvalue oldvalue | convert
  timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | `o365_new_mfa_method_registered_filter`
