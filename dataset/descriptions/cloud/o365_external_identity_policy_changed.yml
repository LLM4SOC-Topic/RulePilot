description: The following analytic identifies when changes are made to the external
  guest policies within Azure AD. With Azure AD B2B collaboration, users and administrators
  can invite external users to collaborate with internal users. This detection also
  attempts to highlight what may have changed. External guest account invitations
  should be monitored by security teams as they could potentially lead to unauthorized
  access. An example of this attack vector was described at BlackHat 2022 by security
  researcher Dirk-Jan during his tall `Backdooring and Hijacking Azure AD Accounts
  by Abusing External Identities`.
required_fields:
- _time
- Operation
- ModifiedProperties{}.NewValue
- ModifiedProperties{}.Name
- UserId
- Workload
rule: sourcetype=o365:management:activity Workload=AzureActiveDirectory Operation="Update
  policy." Target{}.ID="B2BManagementPolicy" | eval object_attrs = mvindex('ModifiedProperties{}.NewValue',0),
  object_attrs_old = mvindex('ModifiedProperties{}.OldValue',0), object_name = mvindex('Target{}.ID',3),
  signature=Operation, user = case(match(mvindex('Actor{}.ID',-1),"User"),mvindex('Actor{}.ID',0),match(mvindex('Actor{}.ID',-1),"ServicePrincipal"),mvindex('Actor{}.ID',3),true(),mvindex('Actor{}.ID',0))
  | spath input=object_attrs_old output=B2BOld path={} | spath input=B2BOld | rename
  B2BManagementPolicy.* as B2BManagementPolicyOld.* | spath input=object_attrs output=B2BNew
  path={} | spath input=B2BNew | eval object_attrs = 'B2BManagementPolicy.InvitationsAllowedAndBlockedDomainsPolicy.AllowedDomains{}'
  , object_attrs_old = 'B2BManagementPolicyOld.InvitationsAllowedAndBlockedDomainsPolicy.AllowedDomains{}'
  | eval diff_add=mvmap(object_attrs,if(isnull(mvfind(object_attrs_old,object_attrs)),object_attrs,null))
  | eval diff_remove=mvmap(object_attrs_old,if(isnull(mvfind(object_attrs,object_attrs_old)),object_attrs_old,null))
  | eval result = case(isnotnull(diff_add),"Added ".mvjoin(diff_add,","),isnotnull(diff_remove),"Removed
  ".mvjoin(diff_remove,",")), action = case(isnotnull(diff_add),"created",isnotnull(diff_remove),"deleted")
  | stats values(object_attrs) as object_attrs, values(action) as action, values(result)
  as result, values(B2BManagementPolicy*) as B2BManagementPolicy*, count, min(_time)
  as firstTime, max(_time) as lastTime by user,signature,object_name | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$)  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `o365_external_identity_policy_changed_filter`
