description: The following analytic identifies the creation of a new AWS IAM policy
  version that allows access to all resources. It detects this activity by analyzing
  AWS CloudTrail logs for the CreatePolicyVersion event with a policy document that
  grants broad permissions. This behavior is significant because it violates the principle
  of least privilege, potentially exposing the environment to misuse or abuse. If
  confirmed malicious, an attacker could gain extensive access to AWS resources, leading
  to unauthorized actions, data exfiltration, or further compromise of the AWS environment.
required_fields:
- _time
- eventName
- userAgent
- errorCode
- eventSource
- requestParameters.userName
- requestParameters.policyDocument
- aws_account_id
- awsRegion
- eventID
rule: sourcetype=aws:cloudtrail eventName=CreatePolicyVersion eventSource = iam.amazonaws.com
  errorCode = success | spath input=requestParameters.policyDocument output=key_policy_statements
  path=Statement{} | mvexpand key_policy_statements | spath input=key_policy_statements
  output=key_policy_action_1 path=Action | where key_policy_action_1 = "*" | stats
  count min(_time) as firstTime max(_time) as lastTime values(key_policy_statements)
  as policy_added by eventName eventSource aws_account_id errorCode userAgent eventID
  awsRegion user user_arn | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)|`aws_create_policy_version_to_allow_all_resources_filter`
