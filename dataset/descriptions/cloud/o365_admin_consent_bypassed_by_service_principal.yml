description: The following analytic identifies instances where a service principal
  in Office 365 Azure Active Directory assigns app roles without standard admin consent.
  It leverages `o365_management_activity` logs, specifically focusing on the 'Add
  app role assignment to service principal' operation. This activity is significant
  for SOCs as it may indicate a bypass of critical administrative controls, potentially
  leading to unauthorized access or privilege escalation. If confirmed malicious,
  this could allow an attacker to misuse automated processes to assign sensitive permissions,
  compromising the security of the environment.
required_fields:
- _time
- Workload
- Operation
- Actor{}.ID
- ModifiedProperties{}.NewValue
- src_user
- dest_user
rule: sourcetype=o365:management:activity Workload=AzureActiveDirectory Operation="Add
  app role assignment to service principal." | eval len=mvcount('Actor{}.ID') | eval
  userType = mvindex('Actor{}.ID',len-1) | eval roleId = mvindex('ModifiedProperties{}.NewValue',
  0) | eval roleValue = mvindex('ModifiedProperties{}.NewValue', 1) | eval roleDescription
  = mvindex('ModifiedProperties{}.NewValue', 2) | eval dest_user = mvindex('Target{}.ID',
  0) | search userType = "ServicePrincipal" | eval src_user = user | stats count earliest(_time)
  as firstTime latest(_time) as lastTime by src_user dest_user roleId roleValue roleDescription
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$)  | `o365_admin_consent_bypassed_by_service_principal_filter`
