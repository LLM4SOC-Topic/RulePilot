description: The following analytic detects outbound emails with attachments sent
  from an internal email domain to an external domain. It leverages Gsuite Gmail logs,
  parsing the source and destination email domains, and flags emails with fewer than
  20 outbound instances. This activity is significant as it may indicate potential
  data exfiltration or insider threats. If confirmed malicious, an attacker could
  use this method to exfiltrate sensitive information, leading to data breaches and
  compliance violations.
required_fields:
- _time
- source.from_header_address
- destination.address
- num_message_attachments
- dest_domain
- phase
- severity
rule: sourcetype=gsuite:gmail:bigquery num_message_attachments > 0 | rex field=source.from_header_address
  "[^@]+@(?<source_domain>[^@]+)" | rex field=destination{}.address "[^@]+@(?<dest_domain>[^@]+)"
  | where source_domain="internal_test_email.com" and not dest_domain="internal_test_email.com"
  | eval phase="plan" | eval severity="low" | stats values(subject) as subject, values(source.from_header_address)
  as src_domain_list, count as numEvents, dc(source.from_header_address) as numSrcAddresses,
  min(_time) as firstTime max(_time) as lastTime by dest_domain phase severity | where
  numSrcAddresses < 20 |sort - numSrcAddresses | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `gsuite_outbound_email_with_attachment_to_external_domain_filter`
