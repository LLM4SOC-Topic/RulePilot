description: The following analytic identifies instances where a single service principal
  creates more than three unique OAuth applications within a 10-minute timeframe.
  It leverages O365 logs from the Unified Audit Log, focusing on the 'Add service
  principal' operation in the Office 365 Azure Active Directory environment. This
  activity is significant as it may indicate a compromised or malicious service principal
  attempting to expand control or access within the network. If confirmed malicious,
  this could lead to unauthorized access and potential lateral movement within the
  environment, posing a significant security risk.
required_fields:
- _time
- Workload
- Operation
- Actor{}.ID
- src_user
- object
rule: sourcetype=o365:management:activity Workload=AzureActiveDirectory Operation="Add
  service principal."  | bucket span=10m _time | eval len=mvcount('Actor{}.ID') |
  eval userType = mvindex('Actor{}.ID',len-1) | search userType = "ServicePrincipal"
  | eval displayName = object | stats count earliest(_time) as firstTime latest(_time)
  as lastTime values(displayName) as displayName dc(displayName) as unique_apps by
  src_user | where unique_apps > 3 | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$)
  | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `o365_multiple_service_principals_created_by_sp_filter`
