description: The following analytic detects an unusually high number of denied Multi-Factor
  Authentication (MFA) requests for a single user within a 10-minute window, specifically
  when more than nine MFA prompts are declined. It leverages Azure Active Directory
  (Azure AD) sign-in logs, focusing on "Sign-in activity" events with error code 500121
  and additional details indicating "MFA denied; user declined the authentication."
  This behavior is significant as it may indicate a targeted attack or account compromise
  attempt, with the user actively declining unauthorized access. If confirmed malicious,
  it could lead to data exfiltration, lateral movement, or further malicious activities.
required_fields:
- _time
- category
- properties.status.errorCode
- properties.status.additionalDetails
- user
- properties.appDisplayName
- user_agent
rule: sourcetype=azure:monitor:aad category=SignInLogs operationName="Sign-in activity"
  | rename properties.* as * | search status.errorCode=500121 status.additionalDetails="MFA
  denied; user declined the authentication" | bucket span=10m _time | stats count
  min(_time) as firstTime max(_time) as lastTime by user, status.additionalDetails,
  appDisplayName, user_agent | where count > 9 | convert timeformat="%Y-%m-%dT%H:%M:%S"
  ctime($field$) | convert timeformat="%Y-%m-%dT%H:%M:%S" ctime($field$) | `azure_ad_multiple_denied_mfa_requests_for_user_filter`
