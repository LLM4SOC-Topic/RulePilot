description: The following analytic detects a series of AWS API calls related to EC2
  snapshots within a short time window, indicating potential exfiltration via EC2
  Snapshot modifications. It leverages AWS CloudTrail logs to identify actions such
  as creating, describing, and modifying snapshot attributes. This activity is significant
  as it may indicate an attacker attempting to exfiltrate data by sharing EC2 snapshots
  externally. If confirmed malicious, the attacker could gain access to sensitive
  information stored in the snapshots, leading to data breaches and potential compliance
  violations.
required_fields:
- _time
- eventName
- user_arn
- src_ip
- requestParameters.attributeType
- aws_account_id
- vendor_region
- user_agent
- userIdentity.principalId
- requestParameters.createVolumePermission.add.items{}.userId
rule: sourcetype=aws:cloudtrail eventName IN ("CreateSnapshot", "DescribeSnapshotAttribute",
  "ModifySnapshotAttribute", "DeleteSnapshot") src_ip !="guardduty.amazonaws.com"
  |  bin _time span=5m |  stats count dc(eventName) as distinct_api_calls values(eventName)  values(requestParameters.attributeType)
  as attributeType values(requestParameters.createVolumePermission.add.items{}.userId)
  as aws_account_id_added values(userAgent) as userAgent by _time userName src_ip
  aws_account_id | where distinct_api_calls >= 2 | `aws_exfiltration_via_ec2_snapshot_filter`
